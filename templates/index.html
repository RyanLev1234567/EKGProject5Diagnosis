<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>EKG Serial Reader</title>
<link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f7d6db;
    color: #662f3d;
    padding: 2rem;
    margin: 0;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  h1 { color: #a53f56; margin-bottom: 1.5rem; font-weight: 700; text-shadow: 0 1px 2px #f2b7bf; }
  button {
    font-size: 1.1rem;
    padding: 0.6rem 1.4rem;
    margin: 0.5rem 0;
    border: none;
    border-radius: 8px;
    background-color: var(--accent-color, #f2b7bf);
    color: var(--accent-text-color, #5a1f2a);
    cursor: pointer;
    box-shadow: 0 3px 6px rgba(194, 94, 108, 0.4);
    transition: background-color 0.3s ease, box-shadow 0.3s ease;
  }
  button:hover, button:focus {
    background-color: var(--accent-hover-color, #e89ca8);
    box-shadow: 0 4px 8px rgba(170, 70, 85, 0.6);
    outline: none;
  }
  #output, #signalAnalysis, #diagnosisOutput {
    width: 90%;
    max-width: 800px;
    background: var(--output-bg, #fff5f7);
    border: 2px solid var(--accent-color, #f2b7bf);
    border-radius: 10px;
    padding: 1rem;
    box-shadow: inset 0 0 8px var(--output-shadow, #f8c9d0);
    color: var(--output-text-color, #8b3b4b);
    font-size: 1rem;
    margin: 1rem 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }
  #actions { margin-bottom: 1rem; }
  #chartContainer {
    width: 90%;
    max-width: 820px;
    border: 2px solid var(--accent-color, #f2b7bf);
    border-radius: 12px;
    background: var(--output-bg, #fff5f7);
    padding: 1rem;
    box-shadow: 0 0 12px var(--output-shadow, #f3bcc6);
  }
  canvas {
    background: white;
    border-radius: 8px;
    box-shadow: 0 3px 6px rgba(194, 94, 108, 0.3);
    display: block;
    margin: 0 auto;
  }
  #statusIndicator {
    display: inline-flex;
    align-items: center;
    margin-left: 1rem;
    font-weight: 600;
    font-size: 1rem;
    color: var(--accent-text-color, #662f3d);
    user-select: none;
  }
  #statusLight {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background-color: gray;
    margin-right: 0.5rem;
    box-shadow: 0 0 6px rgba(0,0,0,0.15);
    transition: background-color 0.3s ease;
  }
  #themeSelector {
    margin-bottom: 1rem;
    font-size: 1.1rem;
    padding: 0.3rem 0.6rem;
    border-radius: 6px;
    border: 1px solid #ccc;
    cursor: pointer;
  }
  @media (max-width: 600px) {
    #output, #chartContainer, #signalAnalysis, #diagnosisOutput { width: 100%; }
    button, #themeSelector { width: 100%; font-size: 1rem; }
  }
</style>
</head>
<body>
<h1>EKG Serial Reader</h1>


<select id="themeSelector" aria-label="Select theme color">
  <option value="pink" selected>Pink</option>
  <option value="red">Red</option>
  <option value="orange">Orange</option>
  <option value="yellow">Yellow</option>
  <option value="lightgreen">Light Green</option>
  <option value="darkgreen">Dark Green</option>
  <option value="lightblue">Light Blue</option>
  <option value="darkblue">Dark Blue</option>
  <option value="purple">Purple</option>
  <option value="teal">Teal</option>
  <option value="brown">Brown</option>
</select>


<div>
  <button id="connectButton">Connect to Arduino</button>
  <button id="scanButton" disabled>Begin Scan (5 sec read)</button>
  <button id="diagnoseButton" disabled>Diagnose</button>


  <span id="statusIndicator">
    <span id="statusLight"></span>
    <span id="statusText">Disconnected</span>
  </span>
</div>


<div id="output"></div>


<div id="signalAnalysis" style="display:none;">
  <strong>Basic Signal Analysis:</strong>
  <ul>
    <li>Minimum Value: <span id="minValue">-</span></li>
    <li>Maximum Value: <span id="maxValue">-</span></li>
    <li>Average Value: <span id="avgValue">-</span></li>
  </ul>
</div>


<div id="diagnosisOutput" style="display:none;">
  <strong>Diagnosis Result:</strong>
  <div id="diagnosisText">-</div>
</div>


<div id="actions" style="display:none;">
  <button id="downloadBtn">Download CSV</button>
  <button id="showGraphBtn">Show ECG Graph</button>
</div>


<div id="chartContainer" style="display:none;">
  <canvas id="ecgChart" width="800" height="300"></canvas>
</div>


<script>
const connectButton = document.getElementById('connectButton');
const scanButton = document.getElementById('scanButton');
const diagnoseButton = document.getElementById('diagnoseButton');
const output = document.getElementById('output');
const actionsDiv = document.getElementById('actions');
const downloadBtn = document.getElementById('downloadBtn');
const showGraphBtn = document.getElementById('showGraphBtn');
const chartContainer = document.getElementById('chartContainer');
const ecgCanvas = document.getElementById('ecgChart');
const statusLight = document.getElementById('statusLight');
const statusText = document.getElementById('statusText');
const signalAnalysisDiv = document.getElementById('signalAnalysis');
const minValueSpan = document.getElementById('minValue');
const maxValueSpan = document.getElementById('maxValue');
const avgValueSpan = document.getElementById('avgValue');
const diagnosisDiv = document.getElementById('diagnosisOutput');
const diagnosisText = document.getElementById('diagnosisText');
const themeSelector = document.getElementById('themeSelector');


let port, reader, readTimeout, dataBuffer = '', dataPoints = [], ecgChart = null, stopReading = false;
const NUM_LEADS = 3; // 3-lead system


// --- Theme System ---
const themes = {
  pink: {
    accentColor:'#f2b7bf', accentTextColor:'#5a1f2a', accentHover:'#e89ca8',
    outputBg:'#fff5f7', outputShadow:'#f8c9d0', outputTextColor:'#8b3b4b',
    graphLineColor:'#e573ab', statusConnected:'#e573ab', statusScanning:'#ff85b5'
  },
  red: {
    accentColor:'#f28b82', accentTextColor:'#5a1f2a', accentHover:'#e06666',
    outputBg:'#ffe5e5', outputShadow:'#f8c0c0', outputTextColor:'#8b3b4b',
    graphLineColor:'#e06666', statusConnected:'#e06666', statusScanning:'#ff8a80'
  },
  orange: {
    accentColor:'#ffa500', accentTextColor:'#5a2a00', accentHover:'#ffb733',
    outputBg:'#fff2e5', outputShadow:'#ffd9b3', outputTextColor:'#8b4f1f',
    graphLineColor:'#ff8c00', statusConnected:'#ff8c00', statusScanning:'#ffb84d'
  },
  yellow: {
    accentColor:'#ffee58', accentTextColor:'#665200', accentHover:'#ffff81',
    outputBg:'#fffde7', outputShadow:'#fff9c4', outputTextColor:'#8b7b2f',
    graphLineColor:'#ffeb3b', statusConnected:'#fdd835', statusScanning:'#fff176'
  },
  lightgreen: {
    accentColor:'#a5d6a7', accentTextColor:'#1b5e20', accentHover:'#81c784',
    outputBg:'#e8f5e9', outputShadow:'#c8e6c9', outputTextColor:'#2e7d32',
    graphLineColor:'#66bb6a', statusConnected:'#388e3c', statusScanning:'#81c784'
  },
  darkgreen: {
    accentColor:'#388e3c', accentTextColor:'#e8f5e9', accentHover:'#2e7d32',
    outputBg:'#e0f2f1', outputShadow:'#a5d6a7', outputTextColor:'#1b5e20',
    graphLineColor:'#2e7d32', statusConnected:'#1b5e20', statusScanning:'#43a047'
  },
  lightblue: {
    accentColor:'#81d4fa', accentTextColor:'#01579b', accentHover:'#4fc3f7',
    outputBg:'#e1f5fe', outputShadow:'#b3e5fc', outputTextColor:'#0277bd',
    graphLineColor:'#29b6f6', statusConnected:'#0288d1', statusScanning:'#4fc3f7'
  },
  darkblue: {
    accentColor:'#1976d2', accentTextColor:'#e3f2fd', accentHover:'#1565c0',
    outputBg:'#e3f2fd', outputShadow:'#90caf9', outputTextColor:'#0d47a1',
    graphLineColor:'#1565c0', statusConnected:'#0d47a1', statusScanning:'#42a5f5'
  },
  purple: {
    accentColor:'#ba68c8', accentTextColor:'#4a148c', accentHover:'#ab47bc',
    outputBg:'#f3e5f5', outputShadow:'#e1bee7', outputTextColor:'#6a1b9a',
    graphLineColor:'#9c27b0', statusConnected:'#7b1fa2', statusScanning:'#ce93d8'
  },
  teal: {
    accentColor:'#4db6ac', accentTextColor:'#004d40', accentHover:'#26a69a',
    outputBg:'#e0f2f1', outputShadow:'#b2dfdb', outputTextColor:'#00796b',
    graphLineColor:'#00897b', statusConnected:'#00695c', statusScanning:'#26a69a'
  },
  brown: {
    accentColor:'#a1887f', accentTextColor:'#3e2723', accentHover:'#8d6e63',
    outputBg:'#efebe9', outputShadow:'#d7ccc8', outputTextColor:'#5d4037',
    graphLineColor:'#6d4c41', statusConnected:'#4e342e', statusScanning:'#8d6e63'
  }
};


let currentStatus = 'disconnected';


function updateStatus(status) {
  currentStatus = status;
  const theme = themes[themeSelector.value] || themes.pink;
  switch(status){
    case 'disconnected': statusLight.style.backgroundColor = 'gray'; statusText.textContent='Disconnected'; break;
    case 'connected': statusLight.style.backgroundColor = theme.statusConnected; statusText.textContent='Connected'; break;
    case 'scanning': statusLight.style.backgroundColor = theme.statusScanning; statusText.textContent='Scanning...'; break;
  }
}


function applyTheme(themeName) {
  const theme = themes[themeName];
  if(!theme) return;
  const root = document.documentElement;
  root.style.setProperty('--accent-color', theme.accentColor);
  root.style.setProperty('--accent-text-color', theme.accentTextColor);
  root.style.setProperty('--accent-hover-color', theme.accentHover);
  root.style.setProperty('--output-bg', theme.outputBg);
  root.style.setProperty('--output-shadow', theme.outputShadow);
  root.style.setProperty('--output-text-color', theme.outputTextColor);
  if(ecgChart) { ecgChart.data.datasets[0].borderColor = theme.graphLineColor; ecgChart.update(); }
  ecgCanvas.style.boxShadow = `0 3px 6px ${theme.accentColor}66`;
  updateStatus(currentStatus);
}


themeSelector.addEventListener('change', e => applyTheme(e.target.value));
applyTheme(themeSelector.value);


// --- Connect to Arduino ---
connectButton.addEventListener('click', async () => {
  output.textContent = 'Connecting...\n';
  dataBuffer = '';
  dataPoints = [];
  actionsDiv.style.display = 'none';
  chartContainer.style.display = 'none';
  signalAnalysisDiv.style.display = 'none';
  diagnosisDiv.style.display = 'none';
  scanButton.disabled = diagnoseButton.disabled = true;
  updateStatus('disconnected');


  try {
    port = await navigator.serial.requestPort();
    await port.open({baudRate:115200});
    output.textContent += 'Port opened successfully.\n';
    scanButton.disabled = false;
    updateStatus('connected');
  } catch(error){
    output.textContent += `Connection error: ${error.message||error}\n`;
    updateStatus('disconnected');
  }
});


// --- Scan Loop ---
scanButton.addEventListener('click', async () => {
  if (!port) { alert('Please connect to the Arduino first.'); return; }


  output.textContent += 'Starting scan for 5 seconds...\n';
  dataBuffer = '';
  dataPoints = [];
  actionsDiv.style.display = 'none';
  chartContainer.style.display = 'none';
  signalAnalysisDiv.style.display = 'none';
  diagnosisDiv.style.display = 'none';
  updateStatus('scanning');
  scanButton.disabled = true;
  diagnoseButton.disabled = true;


  stopReading = false;


  try {
    const decoder = new TextDecoderStream();
    port.readable.pipeTo(decoder.writable);
    reader = decoder.readable.getReader();


    // Stop scan after 5 seconds
    readTimeout = setTimeout(() => { stopReading = true; }, 5000);


    while (!stopReading) {
      const { value, done } = await reader.read();
      if (done) break;
      if (value) dataBuffer += value;
    }


    output.textContent += '\nStopping scan after 5 seconds.\n';
    await closePort();
    output.textContent += '\n--- Full Data Received ---\n' + dataBuffer;


    parseDataForGraph();
    actionsDiv.style.display = 'block';
    updateStatus('disconnected');
    updateSignalAnalysis();
    diagnoseButton.disabled = false;


  } catch (error) {
    output.textContent += `Read error: ${error.message || error}\n`;
    await closePort();
    updateStatus('disconnected');
  }
});


// --- Close Port ---
async function closePort() {
  try {
    if (reader) {
      try { reader.releaseLock(); } catch(e){ console.warn("Reader releaseLock failed:", e); }
      reader = null;
    }
    if (port) {
      await port.close();
      port = null;
    }
  } catch(e){
    output.textContent += `Error closing port: ${e.message || e}\n`;
  }
  if(readTimeout){ clearTimeout(readTimeout); readTimeout = null; }
  scanButton.disabled = true;
  diagnoseButton.disabled = true;
  updateStatus('disconnected');
}


// --- Data & Graph ---
function parseDataForGraph(){
  dataPoints = dataBuffer.split(/\r?\n/).map(l=>parseFloat(l.trim())).filter(x=>!isNaN(x));
}
function updateSignalAnalysis(){
  if(dataPoints.length===0){ signalAnalysisDiv.style.display='none'; return; }
  const min=Math.min(...dataPoints), max=Math.max(...dataPoints), avg=dataPoints.reduce((a,v)=>a+v,0)/dataPoints.length;
  minValueSpan.textContent=min.toFixed(2);
  maxValueSpan.textContent=max.toFixed(2);
  avgValueSpan.textContent=avg.toFixed(2);
  signalAnalysisDiv.style.display='block';
}


// --- CSV Download ---
downloadBtn.addEventListener('click',()=>{
  if(dataPoints.length===0){ alert('No data to download!'); return; }
  let patientName=prompt('Enter the patient name:','');
  if(patientName){patientName=patientName.trim().replace(/[^a-z0-9_\-]/gi,'_');}
  let filename=patientName?`ekg_data_${patientName}.csv`:'ekg_data.csv';
  let csv='EKG_Value\n'+dataPoints.join('\n');
  const blob=new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{document.body.removeChild(a); URL.revokeObjectURL(a.href);},0);
});


// --- Render Graph ---
function renderGraph() {
  if(dataPoints.length===0){ alert('No data to graph!'); return; }
  chartContainer.style.display='block';
  if(ecgChart) ecgChart.destroy();
  const theme = themes[themeSelector.value] || themes.pink;
  ecgChart = new Chart(ecgCanvas.getContext('2d'), {
    type: 'line',
    data: { labels: dataPoints.map((_,i)=>i), datasets:[{label:'EKG Signal', data:dataPoints, borderColor:theme.graphLineColor, borderWidth:1, pointRadius:0, fill:false, tension:0.2}]},
    options:{ animation:false, responsive:true, scales:{ x:{display:true,title:{display:true,text:'Sample Number'}}, y:{display:true,title:{display:true,text:'Signal Value'}, suggestedMin:0, suggestedMax:1023}} }
  });
  ecgCanvas.style.boxShadow = `0 3px 6px ${theme.accentColor}66`;
}
showGraphBtn.addEventListener('click', renderGraph);


// --- Diagnose ---
diagnoseButton.addEventListener('click', async () => {
  if (dataPoints.length === 0) { alert('No data to diagnose!'); return; }
  diagnosisDiv.style.display = 'block';
  diagnosisText.textContent = 'Processing...';


  try {
    // convert to 3-lead rows: [[v,v,v], ...]
    const formattedData = dataPoints.map(v => [v, v, v]);


    const res = await fetch('/diagnose', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ekg_data: formattedData })
    });


    const raw = await res.text();
    let payload;
    try { payload = JSON.parse(raw); } catch { payload = { error: raw || `HTTP ${res.status}` }; }


    if (!res.ok) {
      throw new Error(payload.error || `HTTP ${res.status}`);
    }


    if (payload.probabilities) {
      diagnosisText.innerHTML = '';
      for (const [cls, prob] of Object.entries(payload.probabilities)) {
        const p = document.createElement('div');
        p.textContent = `${cls}: ${(prob * 100).toFixed(1)}%`;
        diagnosisText.appendChild(p);
      }
      // Optional: show shape info to confirm alignment
      if (payload.shape_info) {
        const info = document.createElement('div');
        info.style.marginTop = '0.5rem';
        info.style.fontSize = '0.9rem';
        info.textContent =
          `Model(timesteps=${payload.shape_info.model_expected_timesteps}, leads=${payload.shape_info.model_expected_leads}) • `
          + `Sent(timesteps=${payload.shape_info.provided_timesteps}, leads=${payload.shape_info.provided_leads})`;
        diagnosisText.appendChild(info);
      }
    } else {
      diagnosisText.textContent = payload.diagnosis || ('Error: ' + (payload.error || 'Unknown'));
    }
  } catch (e) {
    diagnosisText.textContent = 'Diagnosis request failed: ' + e.message;
  }
});


</script>
</body>
</html>






